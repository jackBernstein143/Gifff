<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video to GIF Converter</title>
    <style>
        #videoContainer {
            position: relative;
            width: 320px;
            height: 240px;
        }

        #video,
        #gif {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #gif {
            display: none;
        }

        #video {
            border: 2px solid red;
            object-fit: cover;
        }

        #log {
            white-space: pre-wrap;
            background: #f8f9fa;
            border: 1px solid #ced4da;
            padding: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Record Video and Create GIF</h1>
    <div id="videoContainer">
        <video id="video" width="320" height="240" autoplay muted playsinline></video>
        <img id="gif" alt="Generated GIF">
    </div>
    <br>
    <button id="startRecording">Start Recording</button>
    <button id="stopRecording" disabled>Stop Recording</button>
    <br><br>
    <canvas id="canvas" width="320" height="240" style="display: none;"></canvas>
    <br><br>
    <a id="downloadLink" download="output.gif">Download GIF</a>
    <div id="log"></div>

    <script type="module" src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <script type="module">
        const videoElement = document.getElementById('video');
        const gifImg = document.getElementById('gif');
        const startButton = document.getElementById('startRecording');
        const stopButton = document.getElementById('stopRecording');
        const canvas = document.getElementById('canvas');
        const downloadLink = document.getElementById('downloadLink');
        const logElement = document.getElementById('log');

        function logMessage(message) {
            console.log(message);
            logElement.textContent += `${message}\n`;
        }

        let mediaRecorder;
        let recordedChunks = [];

        navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: "user"
            }
        })
        .then(stream => {
            logMessage('Stream obtained');
            videoElement.srcObject = stream;

            videoElement.onloadedmetadata = () => {
                logMessage('Video metadata loaded');
                videoElement.play();
            };

            videoElement.addEventListener('loadeddata', () => {
                logMessage('Video loadeddata event');
            });

            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                const superBuffer = new Blob(recordedChunks, { type: 'video/webm' });
                convertToGIF(superBuffer);
                recordedChunks = [];
            };
        })
        .catch(error => {
            logMessage(`Error accessing webcam: ${error}`);
            alert('Unable to access the camera. Please ensure you have granted permission.');
        });

        startButton.addEventListener('click', () => {
            logMessage('Recording started');
            mediaRecorder.start();
            startButton.disabled = true;
            stopButton.disabled = false;
        });

        stopButton.addEventListener('click', () => {
            logMessage('Recording stopped');
            mediaRecorder.stop();
            startButton.disabled = false;
            stopButton.disabled = true;
        });

        function convertToGIF(videoBlob) {
            logMessage('Converting to GIF...');
            const gif = new GIF({
                workers: 2,
                quality: 10
            });

            const url = URL.createObjectURL(videoBlob);
            const video = document.createElement('video');
            video.src = url;
            video.play();

            video.addEventListener('loadeddata', () => {
                const interval = setInterval(() => {
                    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                    gif.addFrame(canvas, { copy: true, delay: 100 });
                }, 100);

                video.addEventListener('ended', () => {
                    clearInterval(interval);
                    gif.render();
                });
            });

            gif.on('finished', (blob) => {
                logMessage('GIF rendering finished');
                const gifURL = URL.createObjectURL(blob);
                gifImg.src = gifURL;
                gifImg.style.display = 'block';
                videoElement.style.display = 'none';
                downloadLink.href = gifURL;
            });
        }
    </script>
</body>
</html>
